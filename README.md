# 🤖 機械手臂智能控制系統

基於 PyQt5 和 OpenCV 的四軸機械手臂控制系統，整合運動學計算、軌跡規劃與視覺監控功能。

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)
[![PyQt5](https://img.shields.io/badge/PyQt5-5.15+-green.svg)](https://pypi.org/project/PyQt5/)
[![OpenCV](https://img.shields.io/badge/OpenCV-4.5+-red.svg)](https://opencv.org/)

## ✨ 功能特色

### 🎮 即時控制
- **四軸伺服馬達控制**：即時滑桿控制 (範圍 20-160°)
- **雙向同步**：滑桿調整時實體機械手臂同步移動
- **Serial 通訊**：115200 baud，自動偵測 COM 埠

### 📐 運動學系統
- **DH 參數建模**：5 關節 DH 參數表（4 可控 + 1 末端校正）
- **正向運動學**：即時計算末端效應器位置 (x, y, z)
- **逆向運動學**：混合式網格搜尋 + 梯度下降演算法
  - 初始網格：30° 間隔粗略搜尋
  - 精細優化：2° 步進梯度下降
  - 精度：< 5mm 誤差，100% 成功率

### 🎯 軌跡規劃
- **航點記錄**：記錄多個目標位置
- **自動路徑規劃**：線性插值生成平滑軌跡
- **軌跡執行**：500ms 間隔自動執行，可暫停/停止
- **軌跡管理**：儲存/載入 JSON 格式軌跡檔

### 📊 3D 視覺化
- **即時 3D 顯示**：matplotlib 3D 動畫顯示手臂姿態
- **座標軸顯示**：顯示各關節座標系與 DH 參數
- **動態更新**：隨控制即時更新 3D 模型

### 📷 視覺監控
- **攝影機整合**：即時監控機械手臂運動
- **紅點追蹤**：HSV 色彩空間檢測紅色貼紙
- **參數可調**：6 組滑桿調整 HSV 閾值
- **位置顯示**：標示檢測點座標與數量

## 🚀 快速開始

### 安裝需求

```bash
pip install -r requirements.txt
```

**主要依賴套件：**
- PyQt5 >= 5.15
- numpy >= 1.19
- matplotlib >= 3.3
- pyserial >= 3.5
- opencv-python >= 4.5

### 啟動程式

**方式一：使用批次檔（推薦）**
```bash
start_controller.bat
```

**方式二：直接執行**
```bash
python integrated_controller.py
```

### Arduino 設定

1. 上傳 `robot_arm_with_opencv.ino` 到 Arduino
2. 確認使用 PCA9685 I2C 伺服驅動板
3. 硬體連接：
   - SDA → Arduino SDA
   - SCL → Arduino SCL
   - 4 個伺服馬達連接到 PCA9685

## 📖 使用指南

### 1️⃣ 運動學控制標籤

**即時控制模式**
- 拖曳滑桿調整各軸角度（20-160°）
- 實體手臂同步移動
- 觀察 DH 參數與末端位置變化

**航點記錄與軌跡規劃**
1. 調整手臂到目標位置
2. 點擊「記錄當前位置」
3. 重複步驟 1-2 記錄多個航點
4. 點擊「規劃路徑」生成軌跡
5. 觀察 3D 視覺化中的路徑

### 2️⃣ 軌跡執行標籤

**執行軌跡**
1. 從運動學標籤點擊「載入到執行」
2. 或使用「開啟檔案」載入 JSON 軌跡
3. 點擊「開始執行」
4. 使用暫停/停止/繼續控制執行

**軌跡格式（JSON）**
```json
{
  "waypoints": [
    {"theta1": 90, "theta2": 90, "theta3": 90, "theta4": 90},
    {"theta1": 45, "theta2": 60, "theta3": 120, "theta4": 90}
  ]
}
```

### 3️⃣ 視覺監控標籤

**啟動視覺監控**
1. 選擇攝影機 ID（預設 0）
2. 點擊「開啟攝影機」
3. 調整 HSV 閾值以精確檢測紅點
   - H 下限：0，上限：10（紅色色相）
   - S 下限：100，上限：255（飽和度）
   - V 下限：100，上限：255（亮度）

**紅點貼紙建議**
- 在關節位置貼上紅色圓點貼紙
- 避免背景有紅色干擾
- 適當調整光源以提高檢測準確度

## 🎯 運動學參數

### DH 參數表（5 關節）

| 關節 | θ (deg) | d (mm) | a (mm) | α (deg) | 說明 |
|------|---------|--------|--------|---------|------|
| 1 | θ₁ | 77 | 0 | 90 | 底座旋轉（伺服 1）|
| 2 | θ₂ + 90 | 0 | 105 | 0 | 大臂俯仰（伺服 2，反向）|
| 3 | θ₃ | 0 | 98 | 0 | 小臂俯仰（伺服 3）|
| 4 | θ₄ | 0 | 76 | 0 | 末端俯仰（伺服 4，反向）|
| 5 | -90 | 163 | 0 | 0 | 末端校正 |

**註：** 軸 2 和軸 4 有方向反轉映射

### 伺服馬達限制
- **角度範圍**：20° - 160°
- **初始位置**：90°（中立位置）
- **控制精度**：1°
- **移動速度**：約 0.1 秒/60°

## 📁 專案結構

```
robot_arm_with_opencv/
├── integrated_controller.py    # 主控制程式（PyQt5 介面）
├── kinematics_control.py       # 運動學計算模組
├── robot_arm_with_opencv.ino   # Arduino 韌體
├── requirements.txt            # Python 依賴套件
├── start_controller.bat        # 啟動腳本
├── README.md                   # 本文件
├── docs/                       # 文件資料夾
│   └── KINEMATICS_README.md   # 運動學詳細說明
├── tests/                      # 測試與除錯工具
│   ├── test_kinematics.py     # 運動學測試
│   ├── test_simple_ik.py      # 逆運動學測試
│   ├── analyze_kinematics.py  # 運動學分析
│   ├── debug_fk.py            # 正運動學除錯
│   ├── 01.json                # 測試軌跡 1
│   └── test.json              # 測試軌跡 2
└── legacy/                     # 舊版程式碼
    └── robot_arm_controller.py # 第一版控制器
```

## 🔧 Arduino 通訊協定

### 命令格式
```
angle1,angle2,angle3,angle4\n
```

### 範例
```
90,45,120,60\n
```
表示：伺服 1 → 90°，伺服 2 → 45°，伺服 3 → 120°，伺服 4 → 60°

### Arduino 回應
```
OK: Motor angles set
```

## 🐛 故障排除

### 問題：無法連接 Arduino
- 檢查 COM 埠是否正確
- 確認 Arduino 已上傳韌體
- 檢查 USB 線連接

### 問題：逆運動學失敗
- 目標位置可能超出工作空間
- 檢查 DH 參數設定
- 查看日誌記錄中的錯誤訊息

### 問題：視覺監控無法檢測紅點
- 調整 HSV 閾值參數
- 改善光源環境
- 使用更鮮豔的紅色貼紙
- 移除背景紅色干擾

### 問題：手臂移動方向錯誤
- 已在程式中進行軸 2、4 方向反轉
- 如需調整，修改 `get_dh_params()` 函數

## 📝 更新日誌

### v2.0 (2025-12-01)
- ✅ 整合視覺監控功能（OpenCV）
- ✅ 新增紅點追蹤與 HSV 參數調整
- ✅ 完善軌跡執行系統（500ms 間隔）
- ✅ 修正逆運動學演算法（網格搜尋 + 梯度下降）
- ✅ 修正軸 2、4 方向映射問題
- ✅ 改善 3D 動畫效能與穩定性

### v1.0
- ✅ 基礎 Serial 控制
- ✅ PyQt5 圖形介面
- ✅ DH 參數運動學系統
- ✅ 軌跡規劃與記錄功能

## 📄 授權

本專案為教育與研究用途。

## 👨‍💻 開發者

建立於 2025 年，使用 Python + PyQt5 + OpenCV 開發。

---

**注意事項：**
1. 首次連接 Arduino 需等待 2 秒初始化
2. 關閉程式前會自動斷開 Serial 連接與攝影機
3. 建議在良好光源環境下使用視覺監控功能
4. 執行軌跡前請確保手臂周圍無障礙物
